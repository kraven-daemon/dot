#!/usr/bin/env sh

# Synchronizing the lemonbar with herbstluft client

# Some globals
width="$(xrandr | grep " connected" | awk '{print $4}' | cut -d'x' -f1)"
height=24

# ICONS
ibatt=""
ipowa=""
# isignal=""
# igear=""
# ivoff=""
# ivdown=""
# ivup=""
# iqr=""
# icpu=""
iram=""
# idisk=""
# iinfo=""
iclock=""

# color-set background foreground
select="%{B#01f2d1}%{F#041a1e}"
notempty="%{B#007a68}%{F#7fffff}"
empty="%{B#020202}%{F#007a68}"
#urgent=""

## Widget section
clock(){
    printf "%s %s %s%s" "%{A:zenity --calendar:}" "$iclock" "$(date +%H:%M)" "%{A}"
}
mem(){
    printf "%s %s%%" "$iram" "$(free -m | grep Mem: | awk '{print $3/$2*100 }' | cut -d. -f1)"
}

## Tags
tag_gen(){
    num="${2#[#:.!+-%]}"
    printf "%s%s %s %s" "%{A:herbstclient use ${num}:}" "${1}" "${num}" "%{B-F-A}"
}
tags_gen(){
    for t in $(herbstclient tag_status)
    do
        case "${t%[1-5]*}"
            in
            :) tag_gen "${notempty}" "$t";; # tag not empty
            \#) tag_gen "${select}" "$t" ;; # tag focused on monitor
            .) tag_gen "${empty}" "$t"   ;; # tag empty
            #!) tag_gen ${urgent} $t;; # urgent window there
            #+) tag_gen '' $t;; # multi-monitor
            #-) tag_gen '' $t;; # multi-monitor
            #%) tag_gen '' $t;; # multi-monitor
            *) tag_gen "" "$t"           ;;
        esac
    done
}

herbstclient --idle |
while read -r line
do
    case $line
        in
        INIT*)
            tags="$(tags_gen)"
            # wwin=" o_O "
            wtime="$(clock)"
            wram="$(mem)"
        ;;
        tag_changed*) tags="$(tags_gen)";;
        CLOCK*) wtime="$(clock)";;
        RAM*) wram="$(mem)";;

    esac
    echo "${tags} %{r}${wram}${wtime}"
done | lemonbar -p \
    -n "Lemonbar" \
    -g "${width}x${height}+0+0" \
    -B "#041a1e" \
    -F "#01f2d1" \
    -U "#00ff40" \
    -o 1 -u 0 \
    -f "SauceCodePro Nerd Font Mono:style=Semibold,Regular:size=14" | sh &> /dev/null &

# Trigger the first update manually
herbstclient emit_hook INIT

while true
do
    herbstclient emit_hook CLOCK
    sleep 10
done &

while true
do
    herbstclient emit_hook RAM
    sleep 5
done &

